# Global Project Requirements & Product Vision
# 全局项目需求与产品愿景文档

为了方便ai阅读，代码不要超过400行

## 0. 产品定位 (Product Identity)
**核心定位**: 面向主播粉丝的桌面陪伴型番茄钟 (Streamer Fan Companion Pomodoro Widget)。
**关键词**: 陪伴感 (Companionship)、沉浸式 (Immersive)、ASMR/语音 (Voice/Audio)、高颜值 (Visuals)。

### 设计原则 (Design Principles)
1.  **沉浸感第一 (Immersion First)**:
    - 必须是无边框、背景透明的异形窗口 (Character-based)。
    - 拒绝使用原生系统丑陋的控件，所有菜单和按钮都应图形化/定制化。
2.  **粉丝向体验 (Fan-Oriented)**:
    - **语音互动**: 重视语音提醒 (Interval Voice)、节日问候 (Holiday Greetings)、退出语音。
    - **彩蛋**: 保留作弊码 (Cheat Codes) 等隐藏互动功能。
3.  **防误触 (Mistake-Proof)**:
    - 考虑到用户可能一边看直播/玩游戏一边挂着，**严禁**简单的点击人物触发暂停（防止误操作）。
    - 交互必须明确（如专门的按钮）。

---

## 1. 核心交互 (Core Interaction)
- **点击人物 (Click Character)**: 
  - **逻辑**: **仅聚焦窗口 (Focus Only)**。
  - **禁止**: 严禁触发暂停/开始逻辑。防止用户在拖拽或无意点击时打断计时。
- **拖动 (Drag)**: 
  - 左键按住非按钮区域（人物身体）可自由拖动窗口。
- **右键菜单 (Right Click Menu)**: 
  - **触发**: 点击人物身体唤出。
  - **层级**: 必须是 **独立顶层窗口 (Top-Level Window)**，保证永远显示在最顶层，不被人物遮挡。
  - **缩放**: 默认比例需较大 (1.25x)，方便高分屏点击。
  - **功能**: 包含暂停、置顶、音效设置等所有核心功能。
  除了间隔播放语音选择以外，点击后消失，点击其他区域也会消失。

## 2. 按钮逻辑 (Button Logic)
- **开始按钮 (Start Button)**:
  - **位置**: 右上角 (Top-Right)。
  - **状态**: 仅在 Idle (空闲) 状态显示。
  - **样式**: **仅图标 (Icon Only)**，无文字。
- **暂停按钮 (Pause Button)**:
  - **状态**: **界面上不显示** (Hidden from UI)。
  - **操作**: 用户需通过 **右键菜单** 或 **快捷键 (Space)** 暂停。
  - **原因**: 保持界面极简，防止误触。
- **继续按钮 (Resume Button)**:
  - **位置**: 屏幕正中央 (Center)，醒目。
  - **状态**: 仅在 **暂停 (Paused)** 状态下显示。
  - **样式**: 大图标，明确提示用户当前已暂停。
  - **点击后**: 触发继续计时逻辑。

## 3. 缩放与布局 (Scaling & Layout)
人物不能单独拖动！
- **整体操作 (Global Scaling)**:
  - **操作**: **Shift + 滚轮 (Wheel)**缩放全局大小。位置可以**Shift + 左键拖动**。
  - **效果**: 窗口、人物、时间牌、按钮、菜单整体缩放。
  - **稳定性**: 缩放过程中 **严禁闪烁 (No Flickering)**。
- **时间牌操作 (Time Card Operations)**:
  - **独立缩放**: **Ctrl + 滚轮 (Wheel)** (调整字体大小)。
  - **位置调整**: **Ctrl + 左键拖动时间牌** (移动时间牌位置)。时间牌可以在屏幕任意拖动。
  - **时间调整 (Time Adjustment)**:
    - **前提**: 仅在 Idle (空闲) 或 Paused (暂停) 状态下可用。
    - **拖动调节**: 直接左键按住时间牌 **水平/垂直拖动** 即可调整时长。水平：调整秒，垂直：调整分
工作：最长1小时，最短10分钟
休息：最短30秒，最长30分钟
    - **模式切换**: 按 **Alt 键** 切换调节目标（工作时间 Work / 休息时间 Rest）。
    - **快捷预设 (Double Click Zones)**:（双击人物范围）
        - **Work Mode**:
            - Top 25%: 15 min
            - 25-50%: 30 min
            - 50-75%: 40 min
            - Bottom 25%: 60 min
        - **Rest Mode**:
            - Top 25%: 5 min
            - 25-50%: 10 min
            - 50-75%: 15 min
            - Bottom 25%: Toggle "Exit on Work End" (显示 INF 或时间)
  - **核心地位**: 必须始终可见 (Always Visible)，缩放时相对位置不能飘移，且不能飞出屏幕。

## 4. 音频系统 (Audio System)

### 4.1 资源组织与目录 (Organization & Directory)
- **灵活存放**: 音频资源可自由存放于本地 `sounds/` 目录或云端同步目录 `cloud/`。
- **合并策略**: 程序启动时会自动扫描这两个目录，识别并合并所有音频文件。具体存放在哪个目录由主播个人偏好决定（例如将长期固定的语音放在 `sounds/`，将经常变动的语音放在 `cloud/` 以便 Git 更新）。
- **统一结构**: 无论存放在 `sounds/` 还是 `cloud/`，都必须遵循相同的目录结构：
  - **基础分类（共 5 种）**:
    - `start/`: 专注开始
    - `end/`: 休息开始
    - `interval/`: 专注中途提醒
    - `resume/`: 休息结束/恢复工作
    - `exit/`: 退出程序
  - **节日/季节 (Holidays & Seasons)**:
    - `holidays/{holiday_id}/`: 节日专属包（如 `holidays/spring_festival/`）
      - `greeting/`: 节日问候（仅当天首次启动播放）
      - `start/`, `end/`, ...: 节日专属事件语音
    - `seasons/{season_id}/`: 季节专属包（如 `seasons/summer/`）
      - 结构同基础分类。

### 4.2 播放逻辑与采样 (Playback & Sampling)
- **常规采样**: 
  - 所有可用来源（sounds + cloud）的同类语音合并为一个池。
  - 季节目录存在时，仅在对应季节/日期内加入池中，与基础语音等概率随机。
- **特殊节日逻辑 (Special Holidays)**:
  - **生效范围**: 仅在节日当天生效。
  - **Greeting**: 当天首次启动应用时，**必播**节日 Greeting。
  - **事件触发**: 各类事件（Start/End等）在**当日首次触发时**，**必定**使用对应的节日语音。
  - **后续采样**: 当日后续触发时，节日语音与同类基础语音混合，等概率抽样。

## 5. 托盘与图标 (Tray & Icons)
- **动态图标**: 根据当前节日/季节自动切换应用图标 (Tray Icon & Window Icon)。
- **托盘菜单**: 提供显示/隐藏、退出功能。

## 6. 首次启动帮助图片 (First-Launch Help Overlay)
- **触发时机**: 应用第一次运行时自动弹出，之后默认不再自动显示。
- **内容形式**: 显示一张包含软件详细用法的整图，从 `assets/help.png`（优先）或`assets/help.jpg` 加载；如该文件不存在则不弹出。
- **交互**: 支持鼠标拖动移动窗口，滚轮缩放图片，按 Esc 关闭。

## 7. 开发体验与工具 (Developer Experience)
- **Qt Designer 可视化 (WYSIWYG)**:
  - 必须能够在 Qt Designer 中直接预览右键菜单的最终运行效果（背景、图标、透明度）。
  - **自由布局 (No Snapping)**: 右键菜单的布局编辑需支持无吸附（无 Grid Layout 限制）的自由拖拽模式，允许像素级调整位置。

## 8. 配套工具 (Tools)

### 8.1 云端资源生成工具
用于支持 `cloud/` 目录的资源生成与索引。
- **`tools/gen_cloud_normal.py`**: 使用 Edge TTS 生成标准语音文件。
- **`tools/build_cloud_manifest.py`**: 扫描 `cloud/` 目录并生成 `manifest.json` 索引文件。

### 8.2 语音素材归档助手 (Voice Organizer Tool)
位于 `tools/voice_organizer.py` 的独立工具，用于高效整理和分类语音素材。
- **特性**: 双面板设计、双向拖拽、语音识别辅助、音频试听。
- **用途**: 方便主播将录制好的干音快速归档到上述的标准目录结构中。

## 9. 其它功能 (Other Features)
- **作弊码 (Cheat Codes)**: 
  - `/surrender`: 投降 (Work Phase > 15m -> Quit App)。
  - `/remake`: 重置计时器。
  - `/666`: 翻转 (Flip)。
  - `/birYYYY`: 设置生日年份。未设置时默认9999（不播放语音）
- **配置持久化 (Persistence)**: 
  - 保存: 窗口位置、整体缩放比例 (Scale Factor)、时间牌字体大小、音量、工作/休息时长偏好。

## 10. 语音素材归档助手 (Voice Organizer Tool)

位于 `tools/voice_organizer.py` 的独立工具，用于高效整理和分类语音素材。

### 9.1 功能特性
*   **双面板设计**: 左侧为源文件（待处理区），右侧为目标文件夹。
*   **双目标支持**: 右侧支持上下分栏，可同时管理“文件夹 A”和“文件夹 B”。
    *   默认显示单个目标文件夹 (A)。
    *   支持动态添加/移除副目标文件夹 (B)。
*   **双向拖拽**: 
    *   左 -> 右：移动/剪切文件到目标文件夹。
    *   右 -> 左：将文件拖回源文件夹（恢复）。
*   **跨磁盘支持**: 自动处理跨磁盘移动操作。
*   **撤销功能**: 支持 Ctrl+Z 或点击撤销按钮撤销最近的移动操作。
*   **模拟识别**: 左侧列表显示模拟的语音转文字内容（Subtitle 样式）。
*   **语音识别**: 集成 Whisper 模型进行真实语音转文字（需安装 openai-whisper）。
*   **音频试听**: 双击文件或使用右键菜单播放音频（支持 wav/mp3）。

### 9.2 使用说明
1.  运行 `python tools/voice_organizer.py` 启动工具。
2.  左侧选择录音源文件夹。
3.  右侧选择目标归档文件夹。
4.  点击右侧顶部的“+”按钮可开启副目标文件夹（文件夹 B）。
5.  拖拽文件进行归类，或使用 Ctrl+Z 撤销。
6.  选中文件点击“识别”按钮（需安装环境）进行语音转文字。

### 9.3 环境要求
*   PySide6
*   openai-whisper (可选，用于真实识别)
*   torch (可选，用于 Whisper)
*   pydub (可选，用于音频处理)
