# 项目上下文 (Project Context for AI)

这份文档旨在帮助 AI 助手快速理解 `Pomodoro Widget` 项目的架构、核心逻辑和当前状态。

## 1. 项目概览
这是一个基于 Python 和 `PySide6` 开发的桌面番茄钟应用。
核心特点是**无边框窗口**、**角色动画**、**独立计时器挂件**以及**高度可配置的资源**。

## 2. 核心文件结构

*   **`main.py`**: 程序入口和核心逻辑。
    *   `PomodoroWidget` (Class): 主窗口，负责显示角色动画、处理核心状态（工作/休息/待机）、音频播放、配置加载。
    *   `TimerWidget` (Class): 独立的计时器窗口，负责显示时间、处理时间拖拽调整、独立缩放。
*   **`image_menu.py`**: 自定义右键菜单。
    *   `ImageMenu` (Class): 一个基于图片的无边框窗口，模拟右键菜单，提供暂停、置顶、退出等功能。
*   **`download_manager.py`**: (可选) 负责云端资源更新。
*   **`ASSETS_LIST.md`**: 资源文件清单，定义了图片和音频的命名规范。
*   **`settings.json`**: 存储用户配置（上次位置、时长设置、是否置顶等）。

## 3. 关键逻辑说明

### 3.1 窗口架构 (Decoupled Widgets)
项目采用双窗口架构：
1.  **主窗口 (`PomodoroWidget`)**:
    *   显示角色 (`image_label`)。
    *   控制整个应用的生命周期。
    *   管理定时器 (`tick_timer`) 和状态 (`phase`).
2.  **计时器窗口 (`TimerWidget`)**:
    *   作为主窗口的子窗口存在 (`self.timer_widget = TimerWidget(self)`)，但拥有独立的 `Window` 标志，因此可以独立移动。
    *   **位置同步**:
        *   当移动主窗口时，计时器会保持相对位置跟随。
        *   当单独拖动计时器时，会更新相对偏移量 (`timer_offset_x`, `timer_offset_y`) 并保存到配置。
    *   **大小同步**:
        *   主窗口缩放 (`Shift+Scroll`) 仅改变角色大小。
        *   计时器缩放 (`Ctrl+Scroll`) 仅改变计时器字体和背景大小。

### 3.2 状态管理
应用有三种主要状态 (`phase`):
1.  **Idle (待机)**: 等待开始。显示 `idle` 动画或静帧。
2.  **Working (工作)**: 倒计时中。显示 `idle` 动画序列。
3.  **Rest (休息)**: 工作结束后的休息时间。显示 `paused` 动画序列。

*特殊状态*:
*   **Paused**: 在工作或休息中暂停。显示 `paused` 静帧。
*   **Edit Mode**: 调整时间时的临时状态。通过 `Alt` 键在工作时长和休息时长调节之间切换。

### 3.3 交互逻辑
*   **拖拽**: 重写了 `mousePress/Move/Release` 事件。
    *   **TimerWidget**:
        *   `Ctrl` + 左键拖动: 移动计时器窗口位置。
        *   直接左键拖动: 调整时间数值 (Work/Rest duration)。
    *   **PomodoroWidget**:
        *   直接左键拖动: 移动人物窗口位置。
*   **时间调整算法**: 基于鼠标拖动的水平/垂直距离 (`dx`, `dy`) 计算时间增量。水平微调，垂直粗调。

### 3.4 资源加载
*   使用 `resolve_asset()` 和 `sound_path()` 动态查找资源。
*   支持 `assets/` 下的文件夹序列帧动画。
*   支持 `assets/digits/` 下的手写数字图片显示时间。

## 4. 最近更新 (Recent Changes)
*   **TimerWidget 分离**: 将计时器从主窗口的子控件改为独立的顶层窗口，实现了“拖出人物范围”的需求。
*   **背景自适应**: `time_bg.png` 现在只包裹计时器文字，不再随主窗口拉伸。
*   **Ctrl+拖拽**: 优化了时间调整体验，增加了死区判定防止误触。

## 5. 待办/已知问题 (Todos/Known Issues)
*   [ ] **云端同步**: 检查更新功能可能需要进一步测试。
*   [ ] **多屏支持**: 在多显示器环境下，窗口位置的保存和恢复可能需要边缘情况处理。

---
*Generated by Trae AI - 2025*
