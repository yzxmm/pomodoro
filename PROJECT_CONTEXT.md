# 项目上下文 (Project Context for AI)

这份文档旨在帮助 AI 助手快速理解 `Pomodoro Widget` 项目的架构、核心逻辑和当前状态。

## 1. 项目概览
这是一个基于 Python 和 `PySide6` 开发的桌面番茄钟应用。
核心特点是**无边框窗口**、**角色动画**、**独立计时器挂件**以及**高度可配置的资源**。

## 2. 核心文件结构

*   **`main.py`**: 程序入口和核心逻辑。
    *   `PomodoroWidget` (Class): 主窗口，负责显示角色动画、处理核心状态（工作/休息/待机）、音频播放、配置加载。
    *   `TimerWidget` (Class): 独立的计时器窗口，负责显示时间、处理时间拖拽调整、独立缩放。
*   **`image_menu.py`**: 自定义右键菜单。
    *   `ImageMenu` (Class): 一个基于图片的无边框窗口，模拟右键菜单，提供暂停、置顶、退出等功能。
*   **`download_manager.py`**: (可选) 负责云端资源更新。
*   **`ASSETS_LIST.md`**: 资源文件清单，定义了图片和音频的命名规范。
*   **`settings.json`**: 存储用户配置（上次位置、时长设置、是否置顶等）。

## 3. 关键逻辑说明

### 3.1 窗口架构 (Decoupled Widgets)
项目采用双窗口架构：
1.  **主窗口 (`PomodoroWidget`)**:
    *   显示角色 (`image_label`)。
    *   控制整个应用的生命周期。
    *   管理定时器 (`tick_timer`) 和状态 (`phase`).
2.  **计时器窗口 (`TimerWidget`)**:
    *   作为主窗口的子窗口存在 (`self.timer_widget = TimerWidget(self)`)，但拥有独立的 `Window` 标志，因此可以独立移动。
    *   **位置同步**:
        *   当移动主窗口时，计时器会保持相对位置跟随。
        *   当单独拖动计时器时，会更新相对偏移量 (`timer_offset_x`, `timer_offset_y`) 并保存到配置。
    *   **大小同步**:
        *   **全局缩放 (`Shift+Scroll`)**: 调整整个程序的大小，包括角色窗口、计时器字体和菜单按钮。
        *   **计时器独立缩放 (`Ctrl+Scroll`)**: 在布局编辑模式下，仅调整计时器字体大小。

### 3.2 状态管理
应用有三种主要状态 (`phase`):
1.  **Idle (待机)**: 等待开始。显示 `idle` 动画或静帧。
2.  **Working (工作)**: 倒计时中。显示 `idle` 动画序列。
3.  **Rest (休息)**: 工作结束后的休息时间。显示 `paused` 动画序列。

*特殊状态*:
*   **Paused**: 在工作或休息中暂停。显示 `paused` 静帧。
*   **Edit Mode**: 调整时间时的临时状态。通过 `Alt` 键在工作时长和休息时长调节之间切换。

### 3.3 交互逻辑
*   **拖拽**: 重写了 `mousePress/Move/Release` 事件。
    *   **TimerWidget**:
        *   `Ctrl` + 左键拖动: 移动计时器窗口位置。
        *   直接左键拖动: 调整时间数值 (Work/Rest duration)。
    *   **PomodoroWidget**:
        *   直接左键拖动: 移动人物窗口位置。
*   **时间调整算法**: 基于鼠标拖动的水平/垂直距离 (`dx`, `dy`) 计算时间增量。水平微调，垂直粗调。

### 3.4 资源加载
*   使用 `resolve_asset()` 和 `sound_path()` 动态查找资源。
*   支持 `assets/` 下的文件夹序列帧动画。
*   支持 `assets/digits/` 下的手写数字图片显示时间。

## 4. 最近更新 (Recent Changes)
*   **全局缩放**: 实现了 `Shift+Scroll` 调整整个程序大小的功能，同步缩放角色、计时器和菜单。
*   **TimerWidget 分离**: 将计时器从主窗口的子控件改为独立的顶层窗口，实现了“拖出人物范围”的需求。
*   **背景自适应**: `time_bg.png` 现在只包裹计时器文字，不再随主窗口拉伸。
*   **Ctrl+拖拽**: 优化了时间调整体验，增加了死区判定防止误触。

## 5. 待办/已知问题 (Todos/Known Issues)
*   [ ] **云端同步**: 检查更新功能可能需要进一步测试。
*   [ ] **多屏支持**: 在多显示器环境下，窗口位置的保存和恢复可能需要边缘情况处理。

## 6. 云端语音系统 (Cloud Sounds System)

本项目包含一套云端语音生成和管理系统，用于动态更新应用的语音资源。

### 6.1 目录结构
`cloud/` 目录包含了按分类和主题组织的音频文件。

```
cloud/
├── manifest.json       # 生成的索引文件，供挂件消费
├── start/              # 番茄钟开始时的语音
│   ├── 1.mp3           # 普通/默认语音 (直接位于分类文件夹下)
│   ├── 2.mp3
│   ├── christmas/      # 主题语音 (子文件夹)
│   │   └── ...
│   └── dec28/
│       └── ...
├── end/                # 番茄钟结束时的语音
├── interval/           # 番茄钟进行中的提醒语音
├── resume/             # 休息结束恢复工作时的语音
└── exit/               # 应用退出时的语音
```

### 6.2 URL 结构
`manifest.json` 将这些文件映射为 URL。当前前缀为：
`https://raw.githubusercontent.com/yzxmm/pomodoro-assets/main`

示例: `cloud/start/1.mp3` -> `.../cloud/start/1.mp3`

### 6.3 工具脚本 (Tools)

#### 1. `tools/gen_cloud_normal.py`
使用 Edge TTS 生成标准（普通）语音文件。
- **Voice**: `zh-CN-XiaoxiaoNeural`
- **Output**: 直接生成到 `cloud/{category}/` (如 `cloud/start/1.mp3`)
- **Content**: 5 个分类 x 5 句文案 = 25 个文件。

#### 2. `tools/build_cloud_manifest.py`
扫描 `cloud/` 目录并生成 `manifest.json`。
- 基于文件夹名称检测分类 (Categories)。
- 基于子文件夹检测季节/标签 (Seasons/Tags)。
- 直接位于分类文件夹下的文件被视为默认/通用语音。

### 6.4 分类说明
- **start**: 专注开始。
- **end**: 休息时间提醒。
- **interval**: 专注保持/鼓励。
- **resume**: 回到工作提醒。
- **exit**: 程序关闭告别。

---
*Generated by Trae AI - 2025*
